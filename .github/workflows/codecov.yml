on:
    push:
        branches:
            - master
    pull_request:

name: Code Coverage

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v1
            -   uses: actions-rs/toolchain@v1
                with:
                    toolchain: nightly
                    override: true
            -   name: Cache cargo registry
                uses: actions/cache@v1
                with:
                    path: ~/.cargo/registry
                    key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
            -   name: Cache cargo index
                uses: actions/cache@v1
                with:
                    path: ~/.cargo/git
                    key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
            -   uses: actions-rs/cargo@v1
                with:
                    command: build
            -   uses: actions-rs/cargo@v1
                with:
                    command: test
                    args: --all-features --no-fail-fast
                env:
                    CARGO_INCREMENTAL: '0'
                    RUSTFLAGS: '-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Zno-landing-pads'
            -   id: coverage
                uses: actions-rs/grcov@v0.1
            -   name: Archive code coverage results
                uses: actions/upload-artifact@v1
                with:
                    name: code-coverage-report
                    path: ${{ steps.coverage.outputs.report }}
            -   uses: romeovs/lcov-reporter-action@v0.2.17
                with:
                    github-token: ${{ github.token }}
                    lcov-file: ${{ steps.coverage.outputs.report }}
